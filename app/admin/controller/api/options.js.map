{
    "version": 3,
    "sources": [
        "../../../../src/admin/controller/api/options.js"
    ],
    "names": [],
    "mappings": "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",
    "file": "../../../../src/admin/controller/api/options.js",
    "sourcesContent": [
        "'use strict';\nimport Base from './base.js';\nimport request from 'request';\nimport speakeasy from 'speakeasy';\nimport {PasswordHash} from 'phpass';\n\n\nexport default class extends Base {\n  /**\n   * 获取\n   * @return {[type]} [description]\n   */\n  async getAction(){\n    let type = this.get('type');\n    let model = this.model('options');\n    let options = await model.getOptions();\n\n    if(type === '2fa'){\n      if(options.two_factor_auth.length === 32){\n        return this.success({\n          otpauth_url: 'otpauth://totp/firekylin?secret=' + options.two_factor_auth,\n          secret: options.two_factor_auth\n        })\n      }else{\n        let secret = speakeasy.generateSecret({\n          length: 20,\n          name: 'firekylin'\n        });\n        return this.success({\n          otpauth_url: secret.otpauth_url,\n          secret: secret.base32\n        });\n      }\n    } else if(type === 'push') {\n      let push_sites = await this.getPushSites();\n      let result = this.get('key') ? push_sites[this.get('key')] : Object.values(push_sites);\n      return this.success(result);\n    }\n    return this.success();\n  }\n\n  postAction(){\n    let type = this.get('type');\n    if(type === '2faAuth'){\n      let data = this.post();\n      let verified = speakeasy.totp.verify({\n        secret: data.secret,\n        encoding: 'base32',\n        token: data.code,\n        window: 2\n      });\n      return verified ? this.success() : this.fail('TWO_FACTOR_AUTH_ERROR_DETAIL');\n    } else if(type === 'push') {\n      let data = this.post();\n      return this.setPushSites(data.appKey, data);\n    }\n    return super.postAction(this);\n  }\n  /**\n   * 更新选项\n   * @return {[type]} [description]\n   */\n  async putAction(){\n    let type = this.get('type');\n    let data = this.post();\n    if(think.isEmpty(data)){\n      return this.fail('DATA_EMPTY');\n    }\n\n    let model = this.model('options');\n    if( type === 'push' ) {\n      return this.setPushSites(data.appKey, data, false);\n    } else {\n      let result = await model.updateOptions(data);\n      this.success(result);\n    }\n  }\n\n  async deleteAction() {\n    let type = this.get('type');\n    if( type === 'push' ) {\n      let key = this.get('key');\n      if( think.isEmpty(key) ) {\n        return this.fail('KEY_EMPTY');\n      }\n      return this.setPushSites(key, null, false);\n    } else {\n      return super.deleteAction();\n    }\n  }\n\n  async getPushSites() {\n    let options = await this.model('options').getOptions();\n    return options.push_sites || {};\n  }\n\n  async setPushSites(key, data, only = true) {\n    let push_sites = await this.getPushSites();\n    if( only && push_sites.hasOwnProperty(key) ) {\n      return this.fail('KEY_EXIST');\n    }\n\n    if( data === null ) {\n      delete push_sites[key];\n    } else {\n      /** 需要增加验证 key 正确性的请求 **/\n      let reqInstance = think.promisify(request.get);\n      let {appKey, appSecret} = data;\n      let auth_key = (new PasswordHash).hashPassword(`${appSecret}Firekylin`);\n      let checkUrl = `${data.url}/admin/post_push?app_key=${appKey}&auth_key=${auth_key}`;\n      let result = await reqInstance(checkUrl);\n      try{\n        result = JSON.parse(result.body);\n      }catch(e){\n        return this.fail('APP_KEY_SECRET_ERROR');\n      }\n      \n      if( !result.errno ) {\n        push_sites[key] = data;\n      } else {\n        return this.fail(result.errmsg);\n      }\n    }\n\n    let result = await this.model('options').updateOptions('push_sites', JSON.stringify(push_sites));\n    return this.success(result);\n  }\n}\n"
    ]
}