{
    "version": 3,
    "sources": [
        "../../../../src/admin/controller/api/user.js"
    ],
    "names": [],
    "mappings": "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",
    "file": "../../../../src/admin/controller/api/user.js",
    "sourcesContent": [
        "'use strict';\n\nimport Base from './base.js';\nimport nodemailer from 'nodemailer';\n\nexport default class extends Base {\n  /**\n   * get\n   * @return {[type]} [description]\n   */\n  getAction(self){\n    let where = {};\n    if( this.id ) {\n      where.id = this.id;\n    } else {\n      if(this.get('type') === 'contributor') {\n        where = {status: 2, type: 3};\n      } else {\n        where = {status: ['!=', 2], type: ['!=', 3], _logic: 'OR'};\n      }\n    }\n    this.modelInstance.field('id,name,display_name,email,type,status,create_time,last_login_time,app_key,app_secret').where(where);\n    return super.getAction(self);\n  }\n  /**\n   * add user\n   * @return {[type]} [description]\n   */\n  async postAction(self){\n    if( this.get('type') === 'key' ) {\n      return await this.generateKey(self);\n    }\n\n    let data = this.post();\n    let insertId = await this.modelInstance.addUser(data, this.ip());\n    return this.success({id: insertId});\n  }\n\n  async generateKey(self, status) {\n    let isAdmin = this.userInfo.type === firekylin.USER_ADMIN;\n    // let isMine = this.userInfo.id === this.id;\n    if( !isAdmin ) {\n      return this.failed();\n    }\n\n    let app_key = think.uuid();\n    let app_secret = think.uuid();\n\n    await this.modelInstance.generateKey(this.id, app_key, app_secret, status);\n    //TODO: 增加邮件发送 app_key 和 app_secret 的功能\n    let user = await this.modelInstance.where({id: this.id}).find();\n    let options = await this.model('options').getOptions();\n    let transporter = nodemailer.createTransport();\n    let site_url = options.hasOwnProperty('site_url') ? options.site_url : `http://${http.host}`;\n    transporter.sendMail({\n      from: 'no-reply@firekylin.org',\n      to: user.email,\n      subject: `【${options.title}】网站推送申请成功`,\n      text: `你的推送申请审批通过，请将下面的信息添加到自己的博客中完成最后的推送操作。\n        网站名称：${options.title}\n        网站地址：${site_url}\n        app_key: ${app_key}\n        app_secret: ${app_secret}\n      `\n    });\n\n\n    if(status != null) { this.id = null; }\n    return await this.getAction(self);\n  }\n  /**\n   * update user info\n   * @return {[type]} [description]\n   */\n  async putAction(self){\n    let type = this.get('type');\n    //save password\n    if(type === 'savepwd'){\n      let userInfo = this.userInfo;\n      let rows = await this.modelInstance.saveUser({\n        password: this.post('password'),\n        id: userInfo.id\n      }, this.ip());\n      return this.success(rows);\n    }\n\n    if (!this.id) {\n      return this.fail('PARAMS_ERROR');\n    }\n\n    if(type === 'contributor') {\n      return await this.generateKey(self, 1);\n    }\n    let data = this.post();\n    data.id = this.id;\n    let rows = await this.modelInstance.saveUser(data, this.ip());\n    return this.success({affectedRows: rows});\n  }\n}\n"
    ]
}